<html class="light">
<head>
    <meta charset="utf-8" lang="en">
    <title>Markdeep Diagram Drafting Board</title>
    <link rel="stylesheet" href="libs/ttf-iosevka-aile-3.4.6/iosevka-aile.css">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        html {
            --font-size: 14px;
            --font-stack: "Iosevka Aile Web", monospace;

            --sidebar-width: 16rem;
            --sidebar-background-color: #222;

            --status-background-color: #444;

            --precision-helper-background-color: #000;

            --text-color: #eee;
            --link-color: #bbb;
            --hover-color: #999;
            --kbd-background-color: #444;

            --rule-color: #666;

            --input-background-color: #333;
            --input-border-color: #555;
            --input-hover-background-color: #555;
            --input-hover-border-color: #888;
            --input-current-value-color: #aaa;

            --dropper-background-color: #555;
            --dropper-color: #aaa;


            font-size: var(--font-size);
            font-family: var(--font-stack);
            letter-spacing: -0.02em;
        }
        body {
            color: var(--text-color);
        }

        /* SIDEBAR */
        aside {
            width: var(--sidebar-width);
            background-color: var(--sidebar-background-color);
            padding: 1em;
            position: fixed;
            right: 0;
            height: calc(100% - var(--sidebar-width));
            overflow-y: scroll;
        }
        h1 {
            font-size: 4em;
            font-weight: 200;
            line-height: 0.85em;
            letter-spacing: -0.1em;
            text-transform: uppercase;
            margin: -0.07em 0 0 -0.07em;
            text-align: right;
        }
        p {
            margin: 1em 0;
        }
        a {
            color: var(--link-color);
            text-decoration: underline;
        }
        a:hover {
            color: var(--hover-color);
        }
        hr {
            border: none;
            border-top: 1px solid var(--rule-color);
            margin: 1rem 0;
        }
        kbd {
            font: inherit;
            background-color: var(--kbd-background-color);
            padding: 0 0.2rem;
            border-radius: 0.2rem
        }
        button, label {
            font: inherit;
            color: inherit;
            background-color: var(--input-background-color);
            border: 1px solid var(--input-border-color);
            text-align: left;
            margin: 1em 0 0.3em 0;
            padding: 0.5em 0.7em;
            display: block;
            width: 100%;
            text-transform: uppercase;
            border-radius: 0.2rem
        }
        button:hover, label:hover {
            background-color: var(--input-hover-background-color);
            border-color: var(--input-hover-border-color);
        }
        button b {
            float: right;
            height: 0;
            margin-top: -0.3em;
        }
        input[type="range"] {
            width: 100%;
            margin: 0;
        }
        label b {
            font-weight: normal;
            float: right;
            color: var(--input-current-value-color);
        }
        span {
            font-size: 0.85em;
            display: block;
        }
        a.reset {
            display: inline-block;
            text-transform: uppercase;
            text-decoration: none !important;
            font-size: 0.6em !important;
            letter-spacing: 1px;
        }

        /* STATUS */
        footer {
            position: fixed;
            right: 0;
            bottom: 0;
            width: var(--sidebar-width);
            background-color: var(--status-background-color);
            padding: 1em;
            font-size: 0.8em;
            pointer-events: none;
            opacity: 1;
        }
        footer.hidden {
            opacity: 0;
            transition: opacity 0.5s ease-out;
        }

        /* PRECISION HELPER */
        section {
            position: fixed;
            width: var(--sidebar-width);
            height: var(--sidebar-width);
            bottom: 0;
            right: 0;
            background-color: var(--precision-helper-background-color);
        }
        section canvas {
            width: 100%;
            height: 100%;
        }

        /* CROPPING VIEW */
        main {
            width: calc(100vw - var(--sidebar-width));
            height: 100vh;
            background: repeating-linear-gradient(
  -42deg,
  #080808,
  #080808 13px,
  #181818 13px,
  #181818 20px
);
        }
        .dropper {
            padding: 1px; /* fix for margin weirdness */
            background-color: var(--dropper-background-color);
            height: 100%;
        }
        .dropper-text {
            border: 0.4rem dashed var(--dropper-color);
            border-radius: 1em;
            color: var(--dropper-color);
            font-size: 3em;
            width: 40%;
            margin: auto;
            margin-top: 20vh;
            padding: 4rem 2rem;
            text-align: center;
        }
        #main {
            display: block;
            margin: auto;
            max-width: 100%;
            max-height: 100%;
        }

        /* GITHUB CORNER */
        @keyframes octocat-wave {
            0%, 100% {
                transform:rotate(0);
            }
            20%, 60% {
                transform:rotate(-25deg);
            }
            40%, 80% {
                transform:rotate(10deg);
            }
        }
        .github-corner:hover .octo-arm {
            animation:octocat-wave 560ms ease-in-out;
        }
        .github-corner svg {
            --github-corner-size: 4rem;

            fill: var(--link-color);
            color: var(--sidebar-background-color);
            position: absolute;
            top: 0;
            transform: rotate(-90deg);
            right: calc(var(--sidebar-width) - var(--github-corner-size));
            width: var(--github-corner-size);
            height: var(--github-corner-size);
        }
        .github-corner svg:hover {
            fill: var(--hover-color) !important;
        }
    </style>
</head>
<body class="md">
    <aside>
        <h1><em>Crop</em> Circles</h1>
        <p>A tool for circularly cropping <a href="https://en.wikipedia.org/wiki/Center_pivot_irrigation">center pivot irrigation</a> fields from aerial imagery. <a href="https://github.com/doersino/cropcircles#readme">Moreâ€¦</a></p>

        TODO make more link pop up an explanatory window thingy? with keeb shortcuts, etc.

        <hr>

        click and drag from the center to select a circle.
        adjust via the arrow keys or wasd, zoom in or out via <kbd>+</kbd> and <kbd>-</kbd>. press <kbd>shift</kbd> to adjust in larger increments.
        press enter to finish the circle

        TODO checkbox: show already-done circles in main view?
        TODO checkbox: collect in local storage for later zipping or download each circle immediately? then will need a dl button

        <label><input type="checkbox" onclick="togglePreview(this);" checked> show preview</label>
        <span>Hides or shows the superimposed preview.</span>

        <button onclick="copySource(this);">copy source<b></b></button>
        <span>The copied source will be surrounded with asterisks, ready for pasting into a Markdeep document.</span>

        <button onclick="downloadSVG();">download svg<b></b></button>
        <span>Handy for inserting your diagram into a non-Markdeep document. <em>Includes the source in a &lt;metadata&gt; tag.</em></span>

        <hr>

        <label><input type="checkbox" onclick="toggleDarkMode(this);" data-default="light" class="dark-mode-checkbox"> dark mode</label>

        <label>
            <input type="range" min="0.5" max="3.0" step="0.01" value="1.0" data-default="1.0" class="zoom-level-slider" oninput="adjustZoomLevel(this.value)">
            <br>zoom level <b>100%</b>
        </label>
        <span>Scales both source and preview.</span>

        <label>
            <input type="range" min="1.00" max="1.50" step="0.01" value="1.25" data-default="1.25" class="line-height-slider" oninput="adjustLineHeight(this.value)">
            <br>line height <b>1.25em</b>
        </label>
        <label>
            <input type="range" min="-0.30" max="0.45" step="0.01" value="0.15" data-default="0.15" class="letter-spacing-slider" oninput="adjustLetterSpacing(this.value)">
            <br>letter spacing <b>0.15px</b>
        </label>
        <span>Both of the above might need adjusting depending on your zoom level, browser and installed fonts.</span>

        <p><span><em>Your source and these settings are continually written to local storage. They will be restored when you close and reopen this page.</em></span></p>
        <a class="reset" href="javascript:resetSettings();">reset settings</a>
    </aside>
    <section>
        <canvas id="prec"></canvas>
    </section>
    <footer class="hidden"></footer>
    <main>
        <div class="dropper">
            <div class="dropper-text">
                Drop image here
            </div>
        </div>
        <canvas id="main"></canvas>
    </main>

    <img style="display: none;" id="dropped-image">

    <script src="https://code.jquery.com/jquery-latest.js" crossorigin="anonymous"></script>
    <script>

        $('#main').hide();

        $('.dropper')
            .on('dragover', (e) => {
                e.preventDefault();
            })
            .on('drop', (e) => {
                e.preventDefault();
                let files = e.originalEvent.dataTransfer.files;
                if (files.length > 0) {
                    // TODO error if more than 1 file?
                    let reader = new FileReader();
                    reader.onload = (e) => {
                        // I save the image in an img component in case i want to restore to the initial image (img is hidden)
                        $("#dropped-image")
                            .load(() => {
                                // hide the original image and text in drag area
                                $(".dropper").hide();
                                $('#main').show();
                                // display the canvas
                                // TODO display status
                                // draw canvas
                                drawDroppedImage();
                            })
                            .attr("src", e.target.result);
                    };
                    reader.readAsDataURL(files[0]);
                }
            });

        function initCanvas(elem) {

            // set height and width correctly on retina devices
            // w, h: logical pixels
            // W, H: physical pixels
            var w = elem.offsetWidth;
            var h = elem.offsetHeight;
            var dpr = 1;
            var W, H;
            if (window.devicePixelRatio) {
                dpr = window.devicePixelRatio;
                elem.style.width = w + "px";
                elem.style.height = h + "px";
                W = w * dpr;
                H = h * dpr;
            }
            elem.setAttribute("width", W);
            elem.setAttribute("height", H);

            return {
                elem: elem,
                ctx: elem.getContext("2d"),
                w: w,
                h: h,
                W: W,
                H: H
            }
        }

        let prec = document.getElementById("prec");
        let pcanv = initCanvas(prec);
        let pc = pcanv.ctx;
        let W = pcanv.W;
        let H = pcanv.H;

        let main = document.getElementById("main");
        let mc = main.getContext("2d");
        // TODO do the init after the the image has been dropped?

        function drawDroppedImage() {
            var image = document.getElementById("dropped-image");
            main.width = image.width;
            main.height = image.height;
            // TODO also update w, h etc.?
            mc.drawImage(image, 0, 0, image.width, image.height);
            // TODO get the aspect ratio right
        }

        pc.beginPath();
        pc.moveTo(W/3, 0);
        pc.lineTo(W/3, H);
        pc.moveTo(2*W/3, 0);
        pc.lineTo(2*W/3, H);
        pc.moveTo(0, H/3);
        pc.lineTo(W, H/3);
        pc.moveTo(0, 2*H/3);
        pc.lineTo(W, 2*H/3);
        pc.lineWidth = 1;
        pc.strokeStyle = "#fff";
        pc.stroke();
        // TODO divide into 9 views: center and edges. draw at full res (i.e. draw pixels as 2x2 on @2x)


        // helper function for displaying status messages
        function setStatus(message) {
            var status = document.querySelector("footer");
            status.innerHTML = message;
            status.className = "";
            setTimeout(function () {
                var status = document.querySelector("footer");
                status.className = "hidden";
            }, 200);
        }

        var input = document.querySelector("textarea");
        var output = document.querySelector("figure");

        var darkModeCheckbox = document.querySelector(".dark-mode-checkbox");
        var zoomLevelSlider = document.querySelector(".zoom-level-slider");
        var lineHeightSlider = document.querySelector(".line-height-slider");
        var letterSpacingSlider = document.querySelector(".letter-spacing-slider");

        // set font size and restore settings from local storage
        function setup() {

            // restore state from local storage
            if (darkMode = window.localStorage.getItem("dark-mode")) {
                darkModeCheckbox.checked = darkMode == "dark";
                toggleDarkMode(darkModeCheckbox);
            }
            if (zoomLevel = window.localStorage.getItem("zoom-level")) {
                zoomLevelSlider.value = zoomLevel;
                adjustZoomLevel(zoomLevel);
            }
            if (lineHeight = window.localStorage.getItem("input-line-height")) {
                lineHeightSlider.value = lineHeight;
                adjustLineHeight(lineHeight);
            }
            if (letterSpacing = window.localStorage.getItem("input-letter-spacing")) {
                letterSpacingSlider.value = letterSpacing;
                adjustLetterSpacing(letterSpacing);
            }
        }
        setup();

        function togglePreview(checkbox) {
            if (checkbox.checked) {
                output.style.display = "block";
            } else {
                output.style.display = "none";
            }
        }

        function toggleDarkMode(checkbox) {
            if (checkbox.checked) {
                document.documentElement.className = "dark";
                window.localStorage.setItem("dark-mode", "dark");
            } else {
                document.documentElement.className = "light";
                window.localStorage.setItem("dark-mode", "light");
            }
        }

        function adjustZoomLevel(zoomLevel) {
            document.documentElement.style.setProperty('--zoom-level', zoomLevel);
            zoomLevelSlider.parentNode.querySelector("b").innerHTML = parseInt(100 * zoomLevel) + "%";
            window.localStorage.setItem("zoom-level", zoomLevel);
        }

        function adjustLineHeight(lineHeight) {
            document.documentElement.style.setProperty('--input-line-height', lineHeight + "em");
            lineHeightSlider.parentNode.querySelector("b").innerHTML = lineHeight + "em";
            window.localStorage.setItem("input-line-height", lineHeight);
        }

        function adjustLetterSpacing(letterSpacing) {
            document.documentElement.style.setProperty('--input-letter-spacing', letterSpacing + "px");
            letterSpacingSlider.parentNode.querySelector("b").innerHTML = letterSpacing + "px";
            window.localStorage.setItem("input-letter-spacing", letterSpacing);
        }

        function resetSettings() {
            darkModeCheckbox.checked = darkModeCheckbox.getAttribute("data-default") == "dark";
            toggleDarkMode(darkModeCheckbox);

            zoomLevelSlider.value = zoomLevelSlider.getAttribute("data-default");
            adjustZoomLevel(zoomLevelSlider.value);

            lineHeightSlider.value = lineHeightSlider.getAttribute("data-default");
            adjustLineHeight(lineHeightSlider.value);

            letterSpacingSlider.value = letterSpacingSlider.getAttribute("data-default");
            adjustLetterSpacing(letterSpacingSlider.value);
        }

        function nukeLocalStorage() {
            localStorage.removeItem("input-source");
            localStorage.removeItem("dark-mode");
            localStorage.removeItem("zoom-level");
            localStorage.removeItem("input-line-height");
            localStorage.removeItem("input-letter-spacing");
        }
    </script>

    <a href="https://github.com/doersino/cropcircles" class="github-corner" aria-label="View source on GitHub">
        <svg viewBox="0 0 250 250" aria-hidden="true">
            <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
            <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
            <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path>
        </svg>
    </a>
</body>
</html>
